<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Docent Attendance â€” Shared (Firestore)</title>
  <style>
    :root { --bg:#0b0d10; --card:#12161c; --muted:#7c8da5; --text:#e9eef6; --accent:#3b82f6; }
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;
         background:var(--bg);color:var(--text);padding-bottom:16px}
    header{padding:20px 16px 6px; max-width:860px; margin:auto}
    h1{margin:0 0 6px; font-size:clamp(20px,4.5vw,28px)}
    p.sub{margin:0; color:var(--muted); font-size:15px}
    main{max-width:860px; margin:10px auto 80px; padding:0 16px; display:grid; gap:12px}
    .card{background:var(--card); border:1px solid #1e2430; padding:14px; border-radius:16px;
          box-shadow:0 10px 20px rgba(0,0,0,.25)}
    label{display:block; font-weight:600; margin-bottom:8px}
    input[type="text"], input[type="file"]{
      width:100%; background:#0f1319; color:var(--text);
      border:1px solid #1f2733; border-radius:14px; padding:14px 16px; font-size:16px}
    input[type="file"]{padding:12px}
    .row{display:grid; gap:12px; grid-template-columns:1fr}
    .actions{display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px}
    .btn-in{background:#a7f3d0;color:#0b0d10;font-weight:700}
    .btn-out{background:#fecaca;color:#0b0d10;font-weight:700}
    .ts-in{color:#86efac;font-weight:700}
    .ts-out{color:#fca5a5;font-weight:700}
    button{border:1px solid #2a3444; padding:16px 18px; border-radius:16px;
           cursor:pointer; width:100%; font-size:16px}
    table{width:100%; border-collapse:collapse}
    th,td{padding:12px 10px; border-bottom:1px solid #1e2430; text-align:left; vertical-align:middle}
    th{position:sticky; top:0; background:#12161c}
    .hint{color:var(--muted); font-size:13px}
    .thumb{width:64px;height:64px;object-fit:cover;border-radius:12px;border:1px solid #232b39}
    footer{position:sticky; bottom:0;
           background:linear-gradient(180deg, rgba(11,13,16,0), rgba(11,13,16,1) 35%);
           z-index:2; padding-bottom:calc(env(safe-area-inset-bottom) + 0px);}
    .bar{max-width:860px; margin:auto; padding:10px 16px;
         display:flex; gap:8px; align-items:center; justify-content:space-between}
    .nowrap{white-space:nowrap}
    @media (min-width:720px){ .row{grid-template-columns:1fr 1fr} }
  </style>
  <script>
    const MAX_THUMB_EDGE = 320;    // px
    const JPEG_QUALITY   = 0.68;   // quality
  </script>
</head>
<body>
  <header>
    <h1>Docent Attendance</h1>
    <p class="sub">Shared log: everyone at this link sees the same entries. Take a photo on the spot and submit.</p>
  </header>

  <main>
    <section class="card">
      <div class="row">
        <div>
          <label for="fullName">Full name</label>
          <input id="fullName" type="text" placeholder="e.g., Tan Wei Ming" autocomplete="name" />
        </div>
        <div>
          <label for="photo">Photo (opens camera)</label>
          <input id="photo" type="file"
                 accept="image/jpeg,image/png,image/heic,image/heif"
                 capture="environment" />
          <div class="hint">Use the camera prompt (donâ€™t pick from the gallery) for on-the-spot proof.</div>
        </div>
      </div>
      <div class="actions">
        <button class="btn-in" id="checkInBtn" type="button">Check in</button>
        <button class="btn-out" id="checkOutBtn" type="button">Check out</button>
      </div>
    </section>

    <section class="card">
      <div style="overflow:auto">
        <table id="logTable" aria-label="Attendance log">
          <thead>
            <tr>
              <th>#</th>
              <th>Photo</th>
              <th>Name</th>
              <th>Submission Time</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
  </main>

  <footer>
    <div class="bar">
      <div class="hint" id="note">Shared via Firebase Firestore. Anyone can add & view; deletes disabled.</div>
      <div class="nowrap hint" id="count"></div>
    </div>
  </footer>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getFirestore, collection, addDoc, serverTimestamp,
             query, orderBy, limit, onSnapshot } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    // ðŸ”‘ Replace with your Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyCNZA42W4bw-64WmxpDE5a8dLi7f940G2c",
      authDomain: "docent-attendance.firebaseapp.com",
      projectId: "docent-attendance",
      storageBucket: "docent-attendance.firebasestorage.app",
      messagingSenderId: "655144848908",
      appId: "1:655144848908:web:3041b176e69d162adda829"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);
    const entriesRef = collection(db, "entries");

    async function toThumb(file, max=MAX_THUMB_EDGE){
      return new Promise((resolve)=>{
        const img = new Image();
        const url = URL.createObjectURL(file);
        img.onload = ()=>{
          const r = Math.min(1, max/Math.max(img.width, img.height));
          const w = Math.round(img.width*r), h = Math.round(img.height*r);
          const c = document.createElement("canvas"); c.width=w; c.height=h;
          c.getContext("2d").drawImage(img,0,0,w,h);
          const dataUrl = c.toDataURL("image/jpeg",JPEG_QUALITY);
          URL.revokeObjectURL(url);
          resolve(dataUrl);
        };
        img.onerror = ()=> resolve(null);
        img.src = url;
      });
    }

    const state = { entries: [] };

    function fmt(dt){
      return new Intl.DateTimeFormat(undefined,
        {year:'numeric',month:'short',day:'2-digit',
         hour:'2-digit',minute:'2-digit',second:'2-digit'}).format(dt);
    }

    function render(){
      const tbody = document.querySelector("#logTable tbody");
      tbody.innerHTML="";
      state.entries.forEach((e,i)=>{
        const tr = document.createElement("tr");
        const tsClass = e.type==="in" ? "ts-in" : (e.type==="out" ? "ts-out" : "");
        const photoCell = e.thumb ? `<img class="thumb" src="${e.thumb}" alt="thumb"/>` : '<span class="hint">No preview</span>';
        tr.innerHTML = `
          <td>${i+1}</td>
          <td>${photoCell}</td>
          <td>${e.name||"â€”"}</td>
          <td class="${tsClass}">${fmt(new Date(e.submitted_at))}</td>`;
        tbody.appendChild(tr);
      });
      document.getElementById("count").textContent = `${state.entries.length} entries (live)`;
    }

    async function handleSubmit(kind){
      const name = document.getElementById("fullName").value.trim();
      const file = document.getElementById("photo").files[0];
      if (!name){ alert("Please enter your full name."); return; }
      if (!file){ alert("Please take a photo."); return; }

      const thumb = await toThumb(file, MAX_THUMB_EDGE);
      if (!thumb){ alert("Cannot read image. Use JPEG/PNG."); return; }

      await addDoc(entriesRef, {
        name, thumb, type: kind,
        submitted_at: serverTimestamp()
      });

      document.getElementById("photo").value = "";
    }

    const q = query(entriesRef, orderBy("submitted_at","desc"), limit(200));
    onSnapshot(q, (snap)=>{
      state.entries = snap.docs.map(doc=>{
        const d = doc.data();
        const ts = d.submitted_at?.toDate ? d.submitted_at.toDate() : new Date();
        return { id: doc.id, name: d.name||"", thumb: d.thumb||null,
                 type: d.type||null, submitted_at: ts.toISOString() };
      });
      render();
    });

    document.getElementById("checkInBtn").addEventListener("click", ()=>handleSubmit("in"));
    document.getElementById("checkOutBtn").addEventListener("click", ()=>handleSubmit("out"));
  </script>
</body>
</html>
