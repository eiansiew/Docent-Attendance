<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Docent Attendance — Simple Photo Logger</title>
  <style>
    :root { --bg:#0b0d10; --card:#12161c; --muted:#7c8da5; --text:#e9eef6; --accent:#3b82f6; }
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;background:var(--bg);color:var(--text);touch-action:manipulation;-webkit-tap-highlight-color:transparent;padding-bottom:16px}
    header{padding:20px 16px 6px; max-width:860px; margin:auto}
    h1{margin:0 0 6px; font-size:clamp(20px,4.5vw,28px)}
    p.sub{margin:0; color:var(--muted); font-size:15px}
    main{max-width:860px; margin:10px auto 80px; padding:0 16px; display:grid; gap:12px}
    .card{background:var(--card); border:1px solid #1e2430; padding:14px; border-radius:16px; box-shadow:0 10px 20px rgba(0,0,0,.25)}
    label{display:block; font-weight:600; margin-bottom:8px}
    input[type="text"], input[type="file"]{width:100%; background:#0f1319; color:var(--text); border:1px solid #1f2733; border-radius:14px; padding:14px 16px; font-size:16px}
    input[type="file"]{padding:12px}
    .row{display:grid; gap:12px; grid-template-columns:1fr}
    .actions{display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px}
    .btn-in{background:#a7f3d0;color:#0b0d10;border-color:#86efac;font-weight:700}
    .btn-out{background:#fecaca;color:#0b0d10;border-color:#fca5a5;font-weight:700}
    .ts-in{color:#86efac;font-weight:700}
    .ts-out{color:#fca5a5;font-weight:700}
    button{color:var(--text); border:1px solid #2a3444; padding:16px 18px; border-radius:16px; cursor:pointer; width:100%; font-size:16px}
    button.primary{background:linear-gradient(180deg,var(--accent),#1e3a8a); border-color:#2563eb; font-weight:600; color:#fff}
    button#deleteBtn{background:#0f1720}
    table{width:100%; border-collapse:collapse}
    th,td{padding:12px 10px; border-bottom:1px solid #1e2430; text-align:left; vertical-align:middle}
    th{position:sticky; top:0; background:#12161c}
    .hint{color:var(--muted); font-size:13px}
    .thumb{width:64px;height:64px;object-fit:cover;border-radius:12px;border:1px solid #232b39; display:block}
    footer{position:sticky; bottom:0; background:linear-gradient(180deg, rgba(11,13,16,0), rgba(11,13,16,1) 35%); z-index:5; padding-bottom:calc(env(safe-area-inset-bottom) + 0px);} 
    .bar{max-width:860px; margin:auto; padding:10px 16px; display:flex; gap:8px; align-items:center; justify-content:space-between} .actions{position:relative; z-index:6} .actions button{position:relative; z-index:7}
    .nowrap{white-space:nowrap}
    @media (min-width:720px){ .row{grid-template-columns:1fr 1fr} .actions{grid-template-columns:repeat(2,1fr)} }
  </style>
  <script>
    const ADMIN_PASSWORD = "admin123"; // change before sharing

    // Storage policy (keeps QuotaExceededError away)
    const MAX_THUMB_EDGE = 320;       // px (smaller = less storage)
    const JPEG_QUALITY   = 0.68;      // 0..1
    const MAX_ENTRIES    = 20;       // safety cap on rows kept
    const MAX_STORAGE_CHARS = 1_200_000; // ~1.2MB budget for localStorage value (keeps ~20 small thumbs)
  </script>
</head>
<body>
  <header>
    <h1>Docent Attendance</h1>
    <p class="sub">Enter your name, take a photo on the spot, and submit. The system records the submission time.</p>
  </header>

  <main>
    <section class="card">
      <div class="row">
        <div>
          <label for="fullName">Full name</label>
          <input id="fullName" type="text" placeholder="e.g., Tan Wei Ming" autocomplete="name" />
        </div>
        <div>
          <label>Live camera</label>
          <div id="camWrap" style="position:relative; background:#0f1319; border:1px solid #1f2733; border-radius:14px; overflow:hidden;">
            <video id="preview" playsinline autoplay muted style="width:100%; height:auto; display:block; background:#000"></video>
            <div id="camStatus" class="hint" style="position:absolute;left:12px;bottom:8px;right:12px;">Camera ready. Position yourself/scene, then tap Check in/out.</div>
          </div>
          <div class="hint" id="permHint">If the camera doesn’t appear, grant camera permission and reload. This feature requires HTTPS.</div>
        </div>
        </div>
      </div>
      <div class="actions">
        <button class="btn-in" id="checkInBtn">Check in</button>
        <button class="btn-out" id="checkOutBtn">Check out</button>
      </div>
    </section>

    <section class="card">
      <div style="overflow:auto">
        <table id="logTable" aria-label="Attendance log">
          <thead>
            <tr>
              <th>#</th>
              <th>Photo</th>
              <th>Name</th>
              <th>Submission Time</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
  </main>

  <footer>
    <div class="bar">
      <div class="hint" id="note">Entries save on this device. Auto-keeps the latest 20 entries; older ones are removed.</div>
      <div class="nowrap hint" id="count"></div>
      <div class="nowrap hint" id="usage"></div>
    </div>
  </footer>

  <script type="module">
  // --- Thumbnail helper (always stores compact JPEG when possible) ---
  // Capture the current video frame into a compact JPEG dataURL
  async function toThumbFromVideo(videoEl, maxEdge=MAX_THUMB_EDGE){
    if (!videoEl || videoEl.readyState < 2) return null; // HAVE_CURRENT_DATA
    const vw = videoEl.videoWidth, vh = videoEl.videoHeight;
    if (!vw || !vh) return null;
    const r = Math.min(1, maxEdge/Math.max(vw, vh));
    const w = Math.max(1, Math.round(vw*r)), h = Math.max(1, Math.round(vh*r));
    const c = document.createElement('canvas'); c.width=w; c.height=h;
    const ctx = c.getContext('2d');
    ctx.drawImage(videoEl, 0, 0, w, h);
    try { return c.toDataURL('image/jpeg', JPEG_QUALITY); } catch { return null; }
  };
      img.onerror = ()=>{
        URL.revokeObjectURL(url);
        // Fallback for browsers that only decode HEIC from dataURL (e.g., iOS Safari)
        const reader = new FileReader();
        reader.onload = e => {
          const img2 = new Image();
          img2.onload = ()=>{
            const r = Math.min(1, max/Math.max(img2.width, img2.height));
            const w = Math.round(img2.width*r), h = Math.round(img2.height*r);
            const c = document.createElement('canvas'); c.width=w; c.height=h;
            c.getContext('2d').drawImage(img2,0,0,w,h);
            resolve(c.toDataURL('image/jpeg', JPEG_QUALITY));
          };
          img2.onerror = ()=> resolve(null); // not decodable → no preview
          img2.src = e.target?.result || '';
        };
        reader.onerror = ()=> resolve(null);
        reader.readAsDataURL(file);
      };
      img.src = url;
    });
  }

  // --- State ---
  // One-time migration: remove older app keys so trimmed entries are fully culled
  (function migrateCleanOldKeys(){
    try{
      const keep = new Set(['docent-attendance-v4']);
      for (let i=0;i<localStorage.length;i++){
        const k = localStorage.key(i);
        if (k && /^docent-attendance-v[0-9]+/.test(k) && !keep.has(k)){
          try{ localStorage.removeItem(k); }catch{}
        }
      }
    }catch{}
  })();

  
  const state = { entries: [] };
  const storageKey = 'docent-attendance-v4';

  function load(){
    try{ state.entries = JSON.parse(localStorage.getItem(storageKey)||'[]'); }
    catch{ state.entries=[]; }
    // Trim on load if previous versions stored too much
    saveWithTrim();
  }

  function fmt(dt){ return new Intl.DateTimeFormat(undefined, {year:'numeric',month:'short',day:'2-digit', hour:'2-digit',minute:'2-digit',second:'2-digit'}).format(dt); }

  function approxSizeChars(){ return (localStorage.getItem(storageKey)||'').length; }

  function updateMeta(){
    document.getElementById('count').textContent = `${state.entries.length} entr${state.entries.length===1?'y':'ies'}`;
    const kb = (approxSizeChars()/1024).toFixed(0);
    document.getElementById('usage').textContent = `~${kb} KB (current store)`;
  }

  // Save with automatic trimming by size & count; prevents QuotaExceededError
  function saveWithTrim(maxChars=MAX_STORAGE_CHARS){
    // Enforce count limit first
    if (state.entries.length > MAX_ENTRIES){
      state.entries.length = MAX_ENTRIES; // keep newest N (array is newest-first)
      document.getElementById('note').textContent = `Old entries auto-trimmed to ${MAX_ENTRIES} to fit storage.`;
    }

    let json = JSON.stringify(state.entries);
    if (json.length > maxChars){
      // Iteratively drop oldest until fits
      let trimmed = 0;
      while (json.length > maxChars && state.entries.length > 0){
        state.entries.pop(); // drop oldest
        trimmed++;
        json = JSON.stringify(state.entries);
      }
      if (trimmed>0){
        document.getElementById('note').textContent = `Auto-trimmed ${trimmed} old entr${trimmed===1?'y':'ies'} to stay within storage.`;
      }
    }

    try {
      localStorage.setItem(storageKey, json);
      updateMeta();
      return true;
    } catch (e){
      // As a last resort keep pruning until it saves
      let trimmed = 0;
      while(state.entries.length>0){
        state.entries.pop();
        trimmed++;
        try{
          localStorage.setItem(storageKey, JSON.stringify(state.entries));
          document.getElementById('note').textContent = `Auto-trimmed ${trimmed} old entr${trimmed===1?'y':'ies'} (quota limit).`;
          updateMeta();
          return true;
        }catch{ /* keep trimming */ }
      }
      console.warn('Save failed even after trimming.', e);
      return false;
    }
  }

  // --- Render ---
  function render(){
    const tbody = document.querySelector('#logTable tbody');
    tbody.innerHTML='';
    state.entries.forEach((e, i)=>{
      const tr = document.createElement('tr');
      const photoCell = e.thumb ? `<img class="thumb" src="${e.thumb}" alt="thumb"/>` : '<span class="hint">No preview</span>';
      const tsClass = e.type==='in' ? 'ts-in' : (e.type==='out' ? 'ts-out' : '');
      tr.innerHTML = `
        <td>${i+1}</td>
        <td>${photoCell}</td>
        <td>${e.name||'—'}</td>
        <td class="${tsClass}">${fmt(new Date(e.submitted_at))}</td>`;
      tbody.appendChild(tr);
    });
    updateMeta();
  }

  // --- Actions ---
  async function startCamera(){
    const video = document.getElementById('preview');
    const hint = document.getElementById('permHint');
    if (!('mediaDevices' in navigator) || !('getUserMedia' in navigator.mediaDevices)){
      hint.textContent = 'Camera API not available in this browser. Use a modern browser on iOS/Android/desktop.';
      return;
    }
    try{
      const constraints = { video: { facingMode: { ideal: 'environment' } } };
      const stream = await navigator.mediaDevices.getUserMedia(constraints);
      video.srcObject = stream; await video.play();
      const st = document.getElementById('camStatus'); if (st) st.textContent = 'Camera ready. Position yourself/scene, then tap Check in/out.';
    }catch(e){
      const st = document.getElementById('camStatus'); if (st) st.textContent = '';
      hint.textContent = 'Camera permission denied or unavailable. Enable camera access in browser settings and reload.';
    }
  }
  async function handleSubmit(kind){
    const name = document.getElementById('fullName').value.trim();
    if (!name){ alert('Please enter your full name.'); return; }

    const video = document.getElementById('preview');
    const thumb = await toThumbFromVideo(video, MAX_THUMB_EDGE);
    if (!thumb){
      alert('Camera not ready. Ensure camera permission is granted and the preview is visible.');
      return;
    }
    const submitted_at = new Date().toISOString();

    state.entries.unshift({ id: crypto.randomUUID(), name, thumb, submitted_at, type: kind });
    saveWithTrim();
    render();
  }

  // --- Self-tests (run only with ?test=1, non-destructive) ---
  function runSelfTests(){
    console.group('[SelfTests] Storage trimming');
    try{
      const testKey = storageKey + '-test';
      const original = JSON.parse(JSON.stringify(state.entries));
      // Build many dummy entries with sizeable thumbs (~6KB each) to force trimming
      const dummy = 'data:image/jpeg;base64,' + 'X'.repeat(6000);
      state.entries = Array.from({length:50}, (_,i)=>({id:String(i), name:'Test', thumb:dummy, submitted_at:new Date().toISOString()}));
      // Save with a tiny budget to force trim
      const ok = (function saveUnderTinyBudget(){
        const json = JSON.stringify(state.entries);
        let copy = JSON.parse(json);
        // tiny budget ~ 25KB
        let budget = 25_000;
        let trimmed = 0;
        while(JSON.stringify(copy).length > budget && copy.length>0){ copy.pop(); trimmed++; }
        localStorage.setItem(testKey, JSON.stringify(copy));
        console.assert(trimmed>0, 'Should trim something under tiny budget');
        return true;
      })();
      console.assert(ok, 'Simulated save should succeed');
      localStorage.removeItem(testKey);
      state.entries = original; // restore
      // Additional test: type tagging
      const original2 = JSON.parse(JSON.stringify(state.entries));
      state.entries.unshift({id:'t-in', name:'T', thumb:null, submitted_at:new Date().toISOString(), type:'in'});
      state.entries.unshift({id:'t-out', name:'T', thumb:null, submitted_at:new Date().toISOString(), type:'out'});
      console.assert(state.entries[0].type==='out' && state.entries[1].type==='in', 'Check-in/out types should be stored');
      state.entries = original2;
      console.log('Self-tests passed');
    }catch(err){ console.warn('Self-tests skipped/failed', err); }
    console.groupEnd();
  }

  // Init
  const RUN_TESTS = new URLSearchParams(location.search).get('test')==='1';
  load(); render();
  startCamera();
  document.getElementById('checkInBtn').addEventListener('click', ()=>handleSubmit('in'));
  document.getElementById('checkOutBtn').addEventListener('click', ()=>handleSubmit('out'));
  if (RUN_TESTS) runSelfTests();
  </script>
</body>
</html>
